<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transval - User Management</title>
    <link rel="icon" type="image/png" href="Assets/logo-branca-transval.png"> <!-- Assuming you might add this asset -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        crossorigin="anonymous" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'transval-orange': '#ff5d29',
                        'transval-blue': '#01a1ef',
                        'transval-blue-dark': '#0d1a3f', // A custom dark blue for cards
                        'transval-blue-border': '#1e3a8a', // A border color
                    }
                }
            }
        }
    </script>
</head>

<body class="font-sans text-base text-gray-200 bg-blue-950">

    <!-- HEADER -->
    <header
        class="fixed top-0 left-0 w-full z-[702] bg-gradient-to-r from-blue-900 via-blue-950 to-gray-900 bg-opacity-95 shadow-lg">
        <div class="container mx-auto flex justify-between items-center py-4 px-6">
            <h1 class="text-xl md:text-2xl font-bold text-white">User Management</h1>
            <div id="headerUserSection" class="flex items-center space-x-4">
                <p id="welcomeMessage" class="text-white text-sm md:text-base"></p>
                <button id="logoutButton"
                    class="bg-transval-blue hover:bg-sky-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all duration-300"
                    style="display: none;">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="pt-24 md:pt-28"> <!-- Adjusted padding for fixed header -->
        <div class="container mx-auto p-4">

            <!-- Login Section -->
            <div id="loginSection" class="bg-transval-blue-dark p-6 md:p-8 rounded-lg shadow-xl mb-8">
                <h2 class="text-3xl font-bold mb-6 text-white text-center">Login</h2>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="loginEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="loginEmail" name="loginEmail" required
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="loginPassword" name="loginPassword" required
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                    </div>
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-transval-orange to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold px-8 py-3 rounded-full text-lg shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-opacity-50">
                        Login
                    </button>
                </form>
                <p id="loginMessage" class="mt-4 text-sm text-center"></p>
            </div>

            <!-- Logout Section (Content moved to header, div kept for structure if needed by JS, but hidden) -->
            <div id="logoutSection" style="display: none;">
                <!-- welcomeMessage and logoutButton are now in the header -->
            </div>

            <!-- User Creation Form -->
            <div id="createUserSection" class="bg-transval-blue-dark p-6 md:p-8 rounded-lg shadow-xl mb-8"
                style="display: none;">
                <h2 class="text-3xl font-bold mb-6 text-white text-center">Create User</h2>
                <form id="createUserForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-gray-300 text-sm font-bold mb-2">Username:</label>
                        <input type="text" id="username" name="username" required
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                    </div>
                    <div>
                        <label for="email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="email" name="email" required
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="password" name="password" required
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                    </div>
                    <div>
                        <label for="role" class="block text-gray-300 text-sm font-bold mb-2">Role:</label>
                        <select id="role" name="role"
                            class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                            <option value="standard" selected class="bg-blue-950">Standard</option>
                            <option value="admin" class="bg-blue-950">Admin</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-transval-blue to-sky-700 hover:from-sky-600 hover:to-sky-800 text-white font-semibold px-8 py-3 rounded-full text-lg shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-50">
                        Create User
                    </button>
                </form>
            </div>

            <!-- User List -->
            <div id="userListSection" class="bg-transval-blue-dark p-6 md:p-8 rounded-lg shadow-xl"
                style="display: none;">
                <h2 class="text-3xl font-bold mb-6 text-white text-center">User List</h2>
                <ul id="userList" class="space-y-3">
                    <!-- Users will be listed here, styled by JS -->
                </ul>
            </div>

            <!-- Edit User Modal/Form (Initially Hidden) -->
            <div id="editUserModal"
                class="fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center px-4"
                style="display: none;">
                <div class="bg-transval-blue-dark p-6 md:p-8 rounded-lg shadow-xl w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-semibold mb-6 text-white text-center">Edit User</h2>
                    <form id="editUserForm" class="space-y-6">
                        <input type="hidden" id="editUserId" name="editUserId">
                        <div>
                            <label for="editUsername"
                                class="block text-gray-300 text-sm font-bold mb-2">Username:</label>
                            <input type="text" id="editUsername" name="editUsername" required
                                class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                        </div>
                        <div>
                            <label for="editEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="editEmail" name="editEmail" required
                                class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                        </div>
                        <div>
                            <label for="editRole" class="block text-gray-300 text-sm font-bold mb-2">Role:</label>
                            <input type="text" id="editRole" name="editRole" placeholder="standard, admin"
                                class="shadow appearance-none border border-transval-blue-border rounded w-full py-3 px-4 bg-blue-950 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-transval-orange focus:border-transval-orange">
                        </div>
                        <div
                            class="flex flex-col sm:flex-row items-center justify-between mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                            <button type="submit"
                                class="w-full sm:w-auto flex-grow bg-gradient-to-r from-transval-orange to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold px-8 py-3 rounded-full text-lg shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-opacity-50">
                                Save Changes
                            </button>
                            <button type="button" id="cancelEditButton"
                                class="w-full sm:w-auto flex-grow bg-gray-600 hover:bg-gray-700 text-white font-semibold px-8 py-3 rounded-full text-lg shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <p id="editUserMessage" class="mt-4 text-sm text-center"></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL_USERS = 'http://localhost:3000/api/users';
        const API_URL_LOGIN = 'http://localhost:3000/auth/login';
        const API_URL_ADMIN_UPDATE = 'http://localhost:3000/auth/dashboard/admin/update';
        const API_URL_ADMIN_DELETE_BASE = 'http://localhost:3000/auth/dashboard/admin';

        const createUserForm = document.getElementById('createUserForm');
        const userList = document.getElementById('userList');
        const loginForm = document.getElementById('loginForm');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginMessage = document.getElementById('loginMessage');
        const loginSection = document.getElementById('loginSection');

        // Elements moved to header or handled by header's display logic
        const headerUserSection = document.getElementById('headerUserSection');
        const logoutButton = document.getElementById('logoutButton'); // This ID is now on the button in the header
        const welcomeMessage = document.getElementById('welcomeMessage'); // This ID is now on the p in the header

        const createUserSection = document.getElementById('createUserSection');
        const userListSection = document.getElementById('userListSection');

        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');
        const editUserIdInput = document.getElementById('editUserId');
        const editUsernameInput = document.getElementById('editUsername');
        const editEmailInput = document.getElementById('editEmail');
        const editRoleInput = document.getElementById('editRole');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const editUserMessage = document.getElementById('editUserMessage');

        function storeToken(token) {
            localStorage.setItem('authToken', token);
        }

        function storeUserInfo(user) {
            localStorage.setItem('loggedInUser', JSON.stringify(user));
        }

        function getUserInfo() {
            const user = localStorage.getItem('loggedInUser');
            return user ? JSON.parse(user) : null;
        }

        function getToken() {
            return localStorage.getItem('authToken');
        }

        function removeToken() {
            localStorage.removeItem('authToken');
        }

        function removeUserInfo() {
            localStorage.removeItem('loggedInUser');
        }

        function updateLoginUI() {
            const token = getToken();
            const userInfo = getUserInfo();

            if (token && userInfo) {
                loginSection.style.display = 'none';
                // Header elements control
                welcomeMessage.textContent = `Welcome, ${userInfo.username}! (Role: ${userInfo.role})`;
                logoutButton.style.display = 'inline-block';

                userListSection.style.display = 'block';

                if (userInfo.role === 'admin') {
                    createUserSection.style.display = 'block';
                } else {
                    createUserSection.style.display = 'none';
                }
            } else {
                loginSection.style.display = 'block';
                // Header elements control
                welcomeMessage.textContent = '';
                logoutButton.style.display = 'none';

                createUserSection.style.display = 'none';
                userListSection.style.display = 'none';
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch(API_URL_USERS, {
                    headers: {
                        // If listing users itself requires auth, add token here
                        // 'Authorization': `Bearer ${getToken()}` 
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                userList.innerHTML = '';
                users.forEach(user => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-4 bg-blue-950 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0';

                    const userInfo = document.createElement('div');
                    userInfo.innerHTML = `
                        <p class="text-lg font-semibold text-white">${user.username} <span class="text-sm text-transval-blue">(${user.role || 'N/A'})</span></p>
                        <p class="text-sm text-gray-400">${user.email}</p>
                        <p class="text-xs text-gray-500">ID: ${user.id}</p>
                    `;
                    listItem.appendChild(userInfo);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex space-x-2 mt-3 sm:mt-0';

                    const loggedInUser = getUserInfo();
                    if (loggedInUser && loggedInUser.role === 'admin') { // Only admin can see edit/delete
                        const editButton = document.createElement('button');
                        editButton.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        editButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 flex items-center space-x-1';
                        editButton.onclick = () => handleShowEditUserForm(user);
                        actionsDiv.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                        deleteButton.className = 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 flex items-center space-x-1';
                        deleteButton.onclick = () => handleDeleteUser(user.email, user.username);
                        actionsDiv.appendChild(deleteButton);
                    }
                    listItem.appendChild(actionsDiv);
                    userList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching users:', error);
                userList.innerHTML = `<li class="text-transval-orange p-3 bg-blue-950 rounded-lg text-center">Error loading users: ${error.message}</li>`;
            }
        }

        createUserForm.addEventListener('submit', async (event) => { // Removed backslash
            event.preventDefault();
            const username = event.target.username.value;
            const email = event.target.email.value;
            const password = event.target.password.value;
            const role = event.target.role.value;
            const token = getToken();
            const userInfo = getUserInfo();

            const headers = {
                'Content-Type': 'application/json',
            };

            if (token && userInfo && userInfo.role === 'admin') {
                headers['Authorization'] = `Bearer ${token}`;
            } else {
                alert('You do not have permission to create users or are not logged in as admin.');
                return;
            }

            try {
                const response = await fetch(API_URL_USERS, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, email, password, role }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to parse error response' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const newUser = await response.json();
                console.log('User created:', newUser);
                createUserForm.reset();
                fetchUsers();
                alert(`User ${newUser.username} created successfully!`); // Corrected template literal
            } catch (error) {
                console.error('Error creating user:', error);
                alert(`Error creating user: ${error.message}`);
            }
        });

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            loginMessage.textContent = '';

            try {
                const response = await fetch(API_URL_LOGIN, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.message || `HTTP error! status: ${response.status}`);
                }

                if (responseData.token && responseData.user) {
                    storeToken(responseData.token);
                    storeUserInfo(responseData.user);
                    loginMessage.textContent = 'Login successful!';
                    loginMessage.className = 'mt-4 text-sm text-center text-green-400';
                    updateLoginUI();
                    fetchUsers();
                } else {
                    throw new Error(responseData.message || 'Login failed: Invalid response from server.');
                }

            } catch (error) {
                console.error('Login error:', error);
                loginMessage.textContent = `Login failed: ${error.message}`;
                loginMessage.className = 'mt-4 text-sm text-center text-transval-orange';
                removeToken();
                removeUserInfo();
                updateLoginUI();
            }
        });

        logoutButton.addEventListener('click', () => {
            removeToken();
            removeUserInfo();
            // loginMessage is not visible here, but we can set a general message if we had a place for it.
            // For now, UI update is enough.
            updateLoginUI();
            fetchUsers(); // Refresh user list, which will be hidden.
        });

        function handleShowEditUserForm(user) {
            editUserIdInput.value = user.email;
            editUsernameInput.value = user.username;
            editEmailInput.value = user.email;
            editRoleInput.value = user.role || '';
            editUserMessage.textContent = '';
            editUserModal.style.display = 'flex';
        }

        editUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const originalEmail = editUserIdInput.value;
            const newName = editUsernameInput.value;
            const newEmail = editEmailInput.value;
            const newRole = editRoleInput.value;
            const token = getToken();

            if (!token) {
                editUserMessage.textContent = 'Authentication required. Please login.';
                editUserMessage.className = 'mt-4 text-sm text-center text-transval-orange';
                return;
            }

            try {
                const response = await fetch(API_URL_ADMIN_UPDATE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        email: originalEmail,
                        newName: newName,
                        newEmail: newEmail,
                        newRole: newRole
                    })
                });

                const responseData = await response.json().catch(() => ({ message: 'Failed to parse server response.' }));

                if (!response.ok) {
                    throw new Error(responseData.message || `HTTP error! status: ${response.status}`);
                }

                editUserMessage.textContent = 'User updated successfully!';
                editUserMessage.className = 'mt-4 text-sm text-center text-green-400';
                fetchUsers();
                setTimeout(() => {
                    editUserModal.style.display = 'none';
                }, 1500);

            } catch (error) {
                console.error('Error updating user:', error);
                editUserMessage.textContent = `Error: ${error.message}`;
                editUserMessage.className = 'mt-4 text-sm text-center text-transval-orange';
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editUserModal.style.display = 'none';
        });

        async function handleDeleteUser(userEmail, username) {
            if (!confirm(`Are you sure you want to delete user: ${username} (${userEmail})?`)) {
                return;
            }

            const token = getToken();
            if (!token) {
                alert('Authentication required. Please login as admin.');
                return;
            }
            const userInfo = getUserInfo();
            if (!userInfo || userInfo.role !== 'admin') {
                alert('Admin privileges required to delete users.');
                return;
            }


            try {
                const response = await fetch(`${API_URL_ADMIN_DELETE_BASE}/${userEmail}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch (e) {
                        if (response.status === 204) {
                            alert(`User ${username} deleted successfully.`);
                            fetchUsers();
                            return;
                        }
                    }
                    throw new Error(errorMsg);
                }

                if (response.status === 204) {
                    alert(`User ${username} deleted successfully.`);
                } else {
                    const responseData = await response.json().catch(() => null);
                    alert(responseData ? responseData.message : `User ${username} deleted successfully.`);
                }
                fetchUsers();

            } catch (error) {
                console.error('Error deleting user:', error);
                alert(`Error deleting user: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateLoginUI();
            fetchUsers();
            if (API_URL_LOGIN !== 'http://localhost:3000/auth/login') {
                console.warn('API_URL_LOGIN might be outdated. Expected /auth/login. Current:', API_URL_LOGIN);
            }
        });
    </script>
</body>

</html>